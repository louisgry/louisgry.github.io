---
title: 《编程必备》Ch6-操作系统
date: 2019-10-16 13:35:35
categories: Daily
tags: 操作系统
description: os简介、进程管理、作业管理、存储管理、文件管理、设备管理
---
<!-- more -->

# Ch6-操作系统之基础篇
## os简介
- 6-1：章节导学
    - 操作系统的演进
        - 无操作系统：资源利用率很低
        - 批处理系统：资源利用率提升、多道程序设计
        - 分时系统：及时调试程序、资源利用率提升
    - 多道程序设计：在计算机内存中同时存放多个程序
        - 早期批处理系统只能一次处理一个任务，多道程序设计使得批处理系统可以一次处理多个任务
        - 批处理输入，多道程序在计算机的管理程序之下相互穿插运行
        - 对多道程序的管理是操作系统的重要功能
    - 操作系统的五大功能
        - 进程管理、存储管理、作业管理、文件管理、设备管理
- 6-2：操作系统概览
    - 什么是操作系统
        - 操作系统是管理计算机硬件和软件资源的**计算机程序**（管理硬件、提供用户交互的软件系统）
        - 管理配置内存、决定资源供需顺序、控制输入输出设备等
        - 操作系统提供让用户和系统交互的操作界面
    - 操作系统的基本功能
        - 统一管理着计算机资源，如处理器、存储器、IO设备、文件资源
        - 实现了对计算机资源的抽象，用户无需面向硬件接口编程
        - 提供了用户与计算机之间的接口
    - 操作系统的相关概念
        - 并发性：在同一时间间隔发生，有别于并行（同一时刻发生）
        - 共享性：互斥共享形式、同时访问形式
        - 虚拟性：时分复用技术（虚拟处理器、虚拟设备）、空分复用技术（虚拟磁盘、虚拟内存）
        - 异步性：多道程序环境下，允许多个进程并发执行

## 进程管理
- 6-3：进程管理之进程实体
    - 为什么需要进程
        - 进程是系统进行资源分配和调度的基本单位
        - 进程作为程序独立运行的载体保障程序正常执行
        - 进程的存在使得操作系统资源的利用率大幅提升
    - 主存中的进程形态（进程的实体）
        - 进程控制块（PCB）：用于描述和控制进程运行的通用数据结构
            - 四类：进程标识符、处理机状态、进程调度信息、进程控制信息
            - 包括：标识符、状态、程序计数器、内存指针、上下文数据、IO状态信息、记账信息
    - 进程与线程
        - 进程（Process）：操作系统进行资源分配和调度的**基本单位**
        - 线程（Thread）：操作系统进行运行调度的**最小单位**
        - 一个进程可以并发多个线程（多线程）
        - 线程共享进程的资源
- 6-4：进程管理之五状态模型
    - 五状态
        - 创建：创建进程时拥有PCB但其他资源未就绪（`fork`函数接口创建进程）
        - 就绪：其他资源都准备好，只差CPU资源的状态（就绪队列）
        - 阻塞：进程因某种原因放弃CPU的状态（阻塞队列）
        - 执行：进程获得其他资源，也获得CPU执行的状态
        - 终止：系统结束由系统清理或者归还PCB的状态
    - 状态的转换
        - 创建 -> 就绪：创建完成
        - 就绪 <-> 执行：进程调度、时间片完
        - 执行 -> 终止：执行完成
        - 执行 -> 阻塞：IO请求
        - 阻塞 -> 就绪：IO完成
- 6-5：进程管理之进程同步
    - 两个经典问题
        - 生产者-消费者问题：生产者程序和消费者程序并发执行时出错（mutex_lock_demo.cpp）
        - 哲学家进餐问题：死锁
        - 根源问题：彼此间没有通信，需要进程间的同步
    - 为什么需要进程间同步
        - 对竞争资源在多进程间进行使用次序的协调
        - 使得并发执行的多个进程之间可以有效使用资源和相互合作
    - 进程间同步的原则
        - 临界资源：无法同时被多个线程共享访问
        - 四个原则：空闲让进、忙则等待、有限等待、让权等待
        - 同步方法：消息队列、共享存储、信号量
    - 线程同步（进程内多个线程也需要同步）
        - 四个同步方法：互斥量、读写锁、自旋锁、条件变量
- 6-6：Linux的进程管理
    - 进程的类型：前台进程、后台进程、守护进程
        - 前台进程：具有终端，可以和用户交互的进程
        - 后台进程：不和用户进程交互，优先级比前台进程低（以`&`结尾：`python test.py &`）  
        - 守护进程：守护（Daemon）进程是特殊的后台进程，在系统引导时启动，一直运行到系统关闭（进程名字以“d”结尾的：httpd, sshd, mysqld）
            - https://www.nowcoder.com/profile/1972414/myFollowings/detail/10704601
    - 进程的ID
        - 进程的ID（pid）表现为一个非负整数，最大值由操作系统规定
        - 父子进程关系：父进程调用fork函数创建子进程（`pstree`查看）
        - ID为0：idle进程，是系统创建的第一个进程
        - ID为1：init进程，是0号进程的子进程，完成系统初始化，是所有用户进程的祖先进程
    - 进程的状态标记（`man ps`查看解释）
        - **R：TASK_RUNNING，进程正处于运行状态**
        - **S：TASK_INTERRUPTIBLE，睡眠状态**
        - D：TASK_UNINTERRUPTIBLE，IO等待的睡眠状态
        - T：TASK_STOP，暂停状态
        - Z：TASK_DEAD or EXIT_ZOMBIE，退出或僵尸状态
    - 操作Linux进程的相关命令
        - `ps`：列出进程列表 （+`-aux`详细信息，`-u`用户）
        - `ps -aux | grep [pid]`：查看进程状态
        - `ps -ef --forest`：查看进程树
        - `ps -aux --sort=-pcpu`：按CPU使用频率排序
        - `ps -aux --sort=-pmem`：按内存使用大小排序
        - `top`：查看进程的所有状态
        - `kill -9 [pid]`：9表示无条件终止进程

## 作业管理
- 6-7：作业管理之进程调度
    - 进程调度：指计算机通过决策决定哪个就绪进程可以获得CPU使用权
    - 进程调度的三个机制
        - 就绪队列的排队机制：将就绪进程按照一定的方式排成队列，以便调度程序可以最快找到就绪进程
        - 选择运行进程的委派机制：调度程序以一定的策略选择就绪进程，将CPU资源分配给它
        - 新老进程的上下文切换机制：保存当前进程的上下文信息，装入被委派执行进程的运行上下文
    - 进程调度的两个方式（分类依据，老进程执行完与否）
        - 非抢占式的调度
        - 抢占式的调度
        ![抢占、非抢占式调度](/images/19-10-17/1.png)
    - 进程调度算法
        - 先来先服务调度算法 
        - 短进程优先调度算法 
        -  高优先权优先调度算法 
        - 时间片轮转调度算法
- 6-8：作业管理之死锁
    - 死锁的概念
        - 死锁是指两个或两个以上的进程在执行过程中，由于竞争资源或者由于彼此通信而造成的一种阻塞的现象
    - 死锁的产生
        - 竞争资源 
        - 进程调度顺序不当
    - 死锁的四个必要条件（四个都要满足）
        - 互斥条件 
        - 请求保持条件 
        - 不可剥夺条件 
        - 环路等待条件
    - 预防死锁的方法
        - 摒弃请求保持条件
        - 摒弃不可剥夺条件
        - 摒弃环路等待条件
    - 避免死锁：银行家算法
        - 以银行借贷系统分配策略为基础的算法
        - 客户申请的贷款是有限的，每次申请需声明最大资金量
        - 客户在使用贷款后，能够及时归还贷款
        - 算法流程：所需资源表-已分配资源表=还需分配资源表
        ![银行家算法](/images/19-10-17/2.png)

## 存储管理
- 6-9：存储管理之内存分配与回收
    - 存储管理所解决的三个问题
        - 确保计算机有足够的内存处理数据 
        - 确保程序可以从可用内存中获取一部分内存使用 
        - 确保程序可以归还使用后的内存以供其他程序使用
    - 内存分配的过程
        - 单一连续分配
        - 固定分区分配
        - 动态分区分配
    - 动态分区分配
        - 动态分区数据结构
            - 动态分区空闲表数据结构
            - 动态分区空闲链数据结构 
        - 动态分区分配算法
            - 首次适应算法
            - 最佳适应算法
            - 快速适应算法 
    - 内存回收的过程
        - 回收区在空闲区之后：扩容
        - 回收区在空闲区之前：合并
        - 回收区在两个空闲区中间：合并
        - 只有回收区：在回收区创建新的空闲节点
- 6-10：存储管理之段页式存储管理
    - 疑问：
        - 操作系统如何管理进程的空间？
    - 页式存储管理
        - 页面：将进程逻辑空间等分成若干大小的页面
        - 页表：页表记录进程逻辑空间与物理空间的映射
    - 段式存储管理
        - 段：将进程逻辑空间划分成若干段（非等分）
        - 段表：段号、基址、段长
    - 段页式存储管理
        - 分页可以有效提高内存利用率， 分段可以更好满足用户需求，两者结合形成段页式存储管理
        - 先将逻辑空间按段式管理分成若干段，再把段内空间按页式管理等分成若干页
        ![页、段、段页式](/images/19-10-17/3.png)
    - 页和段的对比（段式存储和页式存储都离散地管理了进程的逻辑空间）
        - 页是物理单位，段是逻辑单位
        - 分页是为了合理利用空间，分段是满足用户要求 
        - 页大小由硬件固定，段长度可动态变化 
        -  页表信息是一维的，段表信息是二维的
- 6-11：存储管理之虚拟内存
    - 疑问：
        - 一个游戏10几G，物理内存只有4G，游戏怎么运行的？
    - 虚拟内存概述
        - 把程序使用内存划分，将部分暂时不使用的内存放置在辅存
    - 程序的局部性原理
        - 局部性原理是指CPU访问存储器时，无论是存取指令还是存取数据，所访问的存储单元都趋于聚集在一个较小的连续区域中
        - 如果访问页不在内存，则发出缺页中断，发起页面置换
        - 虚拟内存实际是对物理内存的补充，速度接近于内存，成本接近于辅存
    - 虚拟内存的置换算法
        - 先进先出算法(FIFO) 
        - 最不经常使用算法(LFU) 
        - 最近最少使用算法(LRU)
    - 虚拟内存置换
        - 替换策略发生在Cache-主存层次、主存-辅存层次 
        - Cache-主存层次的替换策略主要是为了解决**速度问题**
        - 主存-辅存层次主要是为了解决**容量问题**
- 6-12：Linux的存储管理
    - Buddy内存管理算法
        -  算法主要是为了解决内存外碎片的问题
        - 将页外碎片问题 -> 页内碎片问题：120k的分给128k的空间
        - 努力让内存分配与相邻内存合并能快速进行
        - 向上取整为2的幂大小
        - Buddy内存回收
        ![Buddy内存管理算法](/images/19-10-17/4.png)
    - Linux的交换空间
        - 交换空间(Swap)是磁盘的一个分区
        - 解决的问题
            - 冷启动内存依赖
            - 系统睡眠依赖 
            - 大进程空间依赖
        - 交换空间和虚拟内存的对比
        

## 文件管理
- 6-13：操作系统的文件管理
    - 逻辑结构的文件类型
        -  有结构文件：文本文件、文档、媒体文件
        -  无结构文件：二进制文件、链接库
    - 文件的逻辑结构
        -  顺序文件：按顺序存放在存储介质中的文件（增删改不方便）
        -  索引文件：为了解决可变长文件存储而发明的一种文件格式（配合索引表）
    - 辅存的分配方式
        -  连续分配：对存储要求高，要求满足容量的连续存储空间
        -  链接分配
            -  隐式链接：可靠性差，任何一个链接出问题都影响整个文件
            -  显式链接：使用k-v（物理块：下一盘块存储）
                - FAT（File Allocation Table）文件系统
        -  索引分配： 把文件的所有盘块集中存储（索引）
    - 存储空间管理
        - 空闲表
        - 空闲链表
        - 位示图
    - 目录管理
        - 目录树：任何文件或目录都只有唯一路径
- 6-14：Linux文件的基本操作
    - Linux的目录
        - Linux设计哲学：一切皆文件
        - 相对路径（../path）、绝对路径
        
    - Linux文件常用操作
        - `touch`：创建文件，`mkdir`创建文件夹
        - `rm`：删除文件，`rm -r`删除文件夹（递归删除）
        - `cat`：查看文件
    - Linux的文件类型
        - 命令：`ls -al`
        - 普通文件`-`，目录文件`d`，符号链接`l`，套接字`s`，设备文件`b、c`，FIFO`p`
- 6-15：Linux的文件系统
    - 文件系统概览
        - FAT：File Allocation Table，早期Dos/Windows使用
        - NTFS：New Technology File System，现在Win使用
        - EXT2/3/4：Extended File System，Linux使用
    - Ext文件系统
        - Boot Sector：启动扇区，安装开机管理程序
        - Block Group：块组，存储数据的实际位置
            - Inode
            - Inode bitmap
            - Data block
             - Block bitmap
            - Superblock
    - Ext文件系统实操
        - `df -T`：查看挂载的磁盘
        - `sudo dumpe2fs /dev/sda2 > dumpe2fs.log`：导入信息到文本中
        - `:set nu`：vim中设置行号
        - `stat dumpe2fs.log`：查看具体文件（Inode、Blocks）

## 设备管理
- 6-16：操作系统的设备管理
    - 广义的IO设备
        - 广义IO设备的概念：对CPU而言，数据的输入/输出，也就是输入/输出设备
        - 广义IO设备的分类：按使用特性、信息交换的单位（b块设备、c字符设备）、设备的共享属性、传输速率
    - IO设备的缓冲区
        - 缓冲区：CPU与IO设备的速率不匹配
        - 缓冲池：操作系统划出可供多个进程使用的公共缓冲区
    - SPOOLing技术（虚拟设备技术）
        - 概念： 是关于慢速字符设备如何与计算机主机交换信息的一种技术
        - SPOOLing技术把同步调用低速设备改为异步调用
            - 在输入、输出之间增加了排队转储环节（输入井、输出井）
            -  SPOOLing负责输入（出）井与低速设备之间的调度 
            -  逻辑上，进程直接与高速设备交互，减少了进程的等待时间            