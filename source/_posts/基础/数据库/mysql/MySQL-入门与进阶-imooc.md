---
title: MySQL-入门与进阶-imooc
date: 2019-11-07 20:32:46
categories: 基础
tags: 
- MySQL
description: 一、MySQL8.0详解与实战（数据库选型、数据库设计、数据库访问、SQL开发、SQL优化、事务和高并发）<br>二、MySQL数据库架构（实例和故事、MySQL性能、基准测试、结构优化、架构设计、索引优化、SQL查询优化、分库分表、监控）<br>三、MySQL电商项目（开发规范、结构设计、explain、备份与恢复、MySQL架构）<br>四、MySQL面试指南（版本、用户管理、服务器配置、日志、存储引擎、架构、备份恢复、管理监控、异常处理）
---
<!-- more -->


## 一、MySQL8.0详解与实战
### Ch1-开篇引导
- 课程目标
    - 用SQL解决企业中存在的真实业务痛点问题
- 课程大纲
    - 数据库选型
        - NoSQL or SQL
        - 各种数据存储系统的适用场景
        - 构建MySQL开发环境
    - 数据库设计
        - 逻辑设计：范式化 vs 反范式化
        - 物理设计
        - 业务分析
    - 数据库访问
        - MySQL驱动
        - 访问故障处理
    - SQL开发
        - 基本功：DCL&DDL&DML
        - 必备技能：常用函数
        - 高阶：CTE、窗口函数
    - SQL优化
        - 分析执行计划
        - 索引和SQL改写
        - 排查性能瓶颈
    - 事务和高并发
        - 什么是事务
        - 高并发的隐患
        - 事务隔离级别
        - 阻塞和死锁

### Ch2-数据库选型
- 问题
    - 面对全新的业务场景，如何开展数据库选型？
- SQL vs NoSQL
    - 关系型数据库
        - 数据结构化存储在二维表中
        - 支持事务的ACID（原子性、一致性、隔离性、持久性）
        - 支持使用SQL进行数据操作
    - 关系型数据库适用场景
        - 数据之间存在着一定的关系，需要关联查询数据的场景
        - 需要事务支持的业务场景
        - 需要使用SQL语言灵活操作数据的场景
    - 非关系型数据库
        - 存储结构灵活，没有固定的结构
        - 对事务的支持弱，但对数据的并发处理性能高
        - 大多不使用SQL处理数据
    - 非关系型数据库适用场景
        - 数据结构不固定的场景
        - 对事务要求不高，但读写并发比较大的场景
        - 对数据处理操作比较简单的场景
- 关系型数据库选型原则
    - 数据库使用是否广泛
    - 数据库的可扩展性
    - 数据库的安全性和稳定性
    - 数据库所支持的系统
    - 数据库的使用成本

### Ch3-数据库设计
- 业务分析
    - 一般步骤：业务分析 -> 逻辑设计 -> 数据类型 -> 对象命名 -> 建立库表
    - 慕课网前端数据库结构设计
    - 总结所需的属性（课程的属性、课程列表、讲师、评论、笔记、用户、评价）
- 逻辑设计
    - 逻辑设计之宽表模式：设计到一张大表中，有很多列
        - 宽表模式问题：数据冗余、数据更新异常（修改一行的值，同时修改了多行），插入异常（缺失主键而无法插入表），删除异常（删除时必须删除另一数据）
        - 宽表模式适用场景：配合列存储的数据报表应用
    - 逻辑设计之数据库设计范式
        - 第一范式：表中的所有字段都是不可再分的
            - 联系方式字段，有手机、邮箱、微信
        - 第二范式：表中必须存在主键，并且非主键依赖于全部的主键
            - 笔记表中，用户积分不依赖于符合主键（用户+章节+标题）
        - 第三范式：表中的非主键列之间不能相互依赖
            - 课程表中，讲师职位依赖于讲师名
    - 面向对象设计
        - 课程对象逻辑建模：课程表、课程方向表、课程分类表、课程难度表
        - 课程列表对象逻辑建模：章节表、小节表、课程同章节关联表、章节同小节关联表（删除关联表，反范式化设计）
        - 用户对象逻辑建模：用户表、讲师表合并（讲师标识字段）
        - 问答评论对象逻辑建模：问答评论表
        - 笔记对象逻辑建模：笔记表
        - 课程评价对象逻辑建模：评价表、用户选课表
    - 范式化设计存在的问题
        - 如何获取出一门课程包括的所有章节和小节信息（需要5张表：课程表、章节表、小节表、课程同章节关联表、章节同小节关联表）
    - 反范式化设计：减少查询时所需要关联表的数量，以提高查询性能
        - 课程表和章节表是一对多的关系：所以可以合并{课程主标题、课程章节名、章节说明、章节编号}，虽然违反第二范式，但是可以少关联表
        - 章节表和小节表也是一对多的关系：合并
        - 现在，只需要3章节就可以查询信息：课程表、章节表、小节表
- 物理设计
    - MySQL常见的存储引擎
        - MyISAM：不支持事务，MySQL5.6之前的默认引擎
        - InnoDB：最常用的事务型存储引擎
        - CSV：不支持事务，以CSV格式存储
        - Archive：不支持事务，只允许查询和新增数据而不允许修改
        - Memory：不支持事务，存储在内存中，容易丢失数据
    - InnoDB存储引擎的特点
        - 支持ACID
        - 数据按主键聚集存储
        - 支持行级锁及MVCC（多版本并发控制）
        - 支持BTree和自适应Hash索引
        - 支持全文和空间索引
    - 根据InnoDB特性优化表逻辑结构
        - 课程表：新增课程ID（自增ID）
        - 章节表：新增章节ID
        - 小节表：新增小节ID
    - 常用的数据类型
        - 整数类型：`tinyint、smallint、mediumint、int、bigint（-2^7~2^7-1）`
        - 浮点类型：`float、double、decimal（精确类型）`
        - 时间类型：`date、time、year、datetime、timestamp（时区）`
        - 字符串类型：`char、varchar、tinytext、text、mediumtext、longtext、enum`
    - 为列选择合适的数据类型
        - 优先选择符合存储数据需求的最小数据类型
            - 举例：字符串转整数存储，如IP地址：`inet_aton('255.255.255.255') = 4294967295`
        - 谨慎使用text、enum字符串类型
            - text：内存临时表不支持大数据类型
            - enum：转为整数存储的
        - 同财务相关的数值型数据，必须使用decimal类型
    - 回归项目的物理设计
        - 课程表字段的数据类型选择：课程ID选int unsigned，时长time
        - 章节表字段的数据类型选择：章节ID选int unsigned，章节编号tinyint(2) unsigned
        - 小节表字段的数据类型选择：小节ID选int unsigned，视频格式enum('avi','mp4','mpeg')
        - 课程分类表字段的数据类型选择：课程分类ID选smallint unsigned
        - 用户表字段的数据类型选择：密码选char(32)、性别选char(2)，说明varchar(100)
        - 问答评论表字段的数据类型选择：评论内容text
    - 数据库对象命名规则
        - 名称必须使用小写字母，可选用下划线分割
        - 禁止使用保留关键字
        - 命名应见名识义，不超过32个字符
        - 临时表必须以tmp为前缀，并以日期为后缀
        - 用于备份的库，表必须以bak为前缀，并以日期为后缀
        - 所有存储相同数据的列名和列类型必须一致
    - 项目的库、表和列命名
    
### Ch4-数据库访问

### Ch5-SQL开发

### Ch6-SQL优化

### Ch7-事务和高并发

## 二、MySQL数据库架构

### Ch1-实例和故事
- 在双11大促中的数据库服务器
    - 和Web服务器的不同：一个可以做水平扩展（集群），另一个要保证完整性和一致性，不能做集群
    - 数据库架构—1主15从：35万QPS、10万TPS（每秒处理的事务数目）
    - 并发量vs同时连接数：连接不一定处理请求，大多数处于sleep状态
    - idle：CPU空闲百分比
- 在大促中是什么影响了数据库性能
    - 超高的QPS和TPS：慢查询、低效率的SQL
    - 大量的并发和超高的CPU使用率
        - 大并发会导致数据库连接数被占满，没连上会出现500错误
        - 超高的CPU使用率会使资源耗尽而宕机
    - 磁盘IO性能突然下降：使用更快的磁盘设备、调整计划任务，如备份计划
    - 网卡IO被占满：减少从服务器数量、进行分级缓存、避免使用select *、分离业务网络和服务器网络
- 还有什么会影响数据库性能
    - 大表带来的问题（大表：行数超过千万行、数据超过10G）
        - 慢查询：很难在一定的时间内过滤出想要的数据
        - 建立索引需要很长的时间
        - 修改表结构需要长时间锁表
    - 如何处理大表
        - 分库分表，难点：分表主键的选择、分表后夸分区数据的查询和统计
        - 归档历史数据，难点：归档时间点的选择、如何进行归档操作
    - 事务是什么
        - 事务：ACID，是数据库系统区别于文件系统的重要特性之一
        - 原子性：转账操作的扣钱和加钱应该一起完成
        - 一致性：转账前后的总金额应该一致
        - 隔离性：扣钱时，如果要汇总账户金额，应汇总扣钱之前的余额
            - 四种隔离级别：未提交读（脏读）、已提交读、可重复读（InnoDB默认，即使另一个commit了也看不到操作，多次读SQL的结果是一样的） 、可串行化（读取的每一行数据都加锁）
        - 持久性：修改后永久保存到数据库
    - 大事务带来的问题（大事务：运行时间长、操作数据多，如余额宝）
        - 锁定太多数据，造成大量的阻塞和锁超时
        - 回滚时所需的时间比较长
        - 执行时间长，容易造成主从延迟
    - 如何处理大事务
        - 避免一次处理太多的数据（如一次处理1000个用户）
        - 移除不必要在事务中的SELECT操作

### Ch2-什么影响了MySQL性能

### Ch3-MySQL基准测试

### Ch4-MySQL数据库结构优化

### Ch5-MySQL高可用架构设计

### Ch6-数据库索引优化

### Ch7-SQL查询优化

### Ch8-数据库的分库分表

### Ch9-数据库监控

## 三、MySQL电商项目

### Ch1-数据库开发规范的制定

### Ch2-电商实例数据库结构设计

### Ch3-MySQL执行计划（explain）分析

### Ch4-MySQL数据库备份和恢复

### Ch5-高性能高可用MySQL架构变迁


## 四、MySQL面试指南

### Ch1-课程介绍
- 面试要求
    - 熟悉MySQL数据库设计、使用及优化
- 课程内容
    - 版本、用户管理、服务器配置、日志、存储引擎、架构、备份恢复、管理监控、异常处理

### Ch2-MySQL版本类问题
- 版本类问题
    - 为什么选择某一发行版本
    - 各种版本之间的缺点和优点
    - 如何对MySQL进行升级
- MySQL发行版本对比
    - MySQL官方版
    - Percona MySQL
    - MariaDB
- MySQL8.0版本的新特性
    - 服务器功能：无frm文件、支持资源管理组、窗口函数...
    - 用户安全功能：默认使用caching_sha2_password认证插件
    - InnoDB功能：DDL语句支持原子操作 

### Ch3-用户管理类问题
- 用户管理类问题
    - 给定场景下对用户授权
    - 数据库帐号的安全
    - 如何迁移数据库帐号
- MySQL数据库账号定义
    - `用户名@可访问控制列表`：%表示所有IP
- 用户授权
    - `Grant`命令授权

### Ch4-服务器配置类问题
- 服务器配置类问题
    - SQLMode的影响
    - 对比运行时配制
    - MySQL关键参数
- 分析一个Group By语句的异常原因
    - SQL_Mode：配置MySQL处理SQL的方式（ONLY_FULL_GROUP_BY）
- 比较系统运行配置和配置文件中的配置
    - 使用set配置动态参数，修改系统配置
    - 使用pt-config-diff工具比较配置文件
- 常用的性能参数
    - `max_connections`：最大连接数

### Ch5-日志类问题
- 日志类问题
    - 常用MySQL日志有哪些，在什么情况下使用？
    - 如何通过日志来审计用户活动
- 常用日志类型
    - 错误日志
    - 常规日志
    - 慢查询日志
    - 二进制日志
    - 中继日志

### Ch6-存储引擎类问题
- 存储引擎类问题
    - 说说你了解MySQL存储引擎及其适用场景
    - 在什么情况下InnoDB无法在线修改表结构
    - 无法在线修改表结构时，要如何操作 
    - Innodb是如何实现事务的
    - InnoDB读操作是否会阻塞写操作（InnoDB MVCC实现方式）
- 常用存储引擎
    - MyISAM、CSV、Archive、Memory、Innodb、NDB
- InnoDB不支持在线修改表结构的场景
    - 加全文索引、加空间索引、删除主键...
- 如何更安全的在线修改表结构
    - `pt-online-schema-change [options] dsn`
- Innodb是如何实现事务的
    - 原子性(A)：回滚日志
    - 一致性(C)：重作日志
    - 隔离性(I)：锁，用于资源隔离，分为共享锁和排它锁
    - 持久性(D)：重作日志+回滚日志
- InnoDB MVCC实现方式
    - InnoDB查询对资源加共享锁(S)，修改加排它锁(x)
    - MVCC（多版本并发控制）：通过加共享锁和排它锁实现

### Ch7-MySQL架构类问题
- 高可用架构类问题
    - MySQL的主从复制是如何工作的
    - 比较基于GTID方式的复制和基于日志点的复制
    - 比较MMM和MHA两种高可用架构的优缺点
    - 如何减少主从复制延迟
    - 如何使用MGR集群
    - 如何解决数据库读/写负载大的问题
- MySQL主从复制的实现原理
     - MySQL异步复制
     - MySQL半同步复制
     - MySQL主从复制的配置步骤
- 主从复制的方式
    - 基于日志点的复制
    - 基于GTID的复制
    - 两种复制方式的对比
- MMM和MHA两种高可用复制架构
    - MMM架构
    - MHA架构
- 减少主从复制延迟
- MGR复制
- 解决数据库读/写负载大的问题

### Ch8-备份恢复类问题
- 备份恢复类问题
    - 数据库备份的种类
    - 常用备份工具的使用方法
    - 如何对数据库进行全量备份和增量备份
    - 如何恢复数据库备份

### Ch9-管理及监控类问题
- 管理及监控类问题
    - 如何监控死锁
    - 如何监控慢查询
    - 如何监控主从延迟
    - 如何监控主从状态

### Ch10-异常处理类问题
- 优化及异常处理类问题
    - CPU负载过大问题的分析和处理
    - IO负载过大问题的分析和处理
    - 如何解决主从数据不一致问题
    - 如何解决复制中的主键冲突
    - 如何解决RelayLog故障
    - 数据库优化概论

